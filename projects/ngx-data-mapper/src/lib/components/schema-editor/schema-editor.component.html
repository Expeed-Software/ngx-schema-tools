<div class="schema-editor">
  <!-- Schema Header -->
  <div class="editor-header">
    <div class="schema-name-section">
      <mat-form-field appearance="outline" class="schema-name-field">
        <mat-label>Schema Name</mat-label>
        <input
          #schemaNameInput
          matInput
          [value]="schemaName()"
          (input)="onSchemaNameChange($any($event.target).value, schemaNameInput)"
          placeholder="Enter schema name"
        />
      </mat-form-field>
    </div>
    <div class="header-actions">
      <button mat-flat-button color="primary" (click)="addField()">
        <mat-icon>add</mat-icon>
        Add Field
      </button>
    </div>
  </div>

  <!-- Fields List -->
  <div class="fields-container">
    @if (fields().length === 0) {
      <div class="empty-state">
        <mat-icon>schema</mat-icon>
        <p>No fields yet. Click "Add Field" to get started.</p>
      </div>
    } @else {
      <div class="fields-list">
        <ng-container *ngTemplateOutlet="fieldListTemplate; context: { fields: fields(), level: 0, parentList: fields() }"></ng-container>
      </div>
    }
  </div>
</div>

<!-- Recursive Field Template -->
<ng-template #fieldListTemplate let-fields="fields" let-level="level" let-parentList="parentList">
  @for (field of fields; track trackByFieldId($index, field); let i = $index; let first = $first; let last = $last) {
    <div
      class="field-item"
      [class.has-children]="field.children && field.children.length > 0"
      [class.is-editing]="field.isEditing"
      [class.is-complex]="field.type === 'object' || field.type === 'array'"
      [style.--level]="level"
    >
      <!-- Reorder Buttons -->
      <div class="reorder-buttons">
        <button
          class="reorder-btn"
          [disabled]="first"
          (click)="moveFieldUp(field, parentList)"
          matTooltip="Move up"
        >
          <mat-icon>keyboard_arrow_up</mat-icon>
        </button>
        <button
          class="reorder-btn"
          [disabled]="last"
          (click)="moveFieldDown(field, parentList)"
          matTooltip="Move down"
        >
          <mat-icon>keyboard_arrow_down</mat-icon>
        </button>
      </div>

      <!-- Indent/Outdent Buttons -->
      <div class="indent-buttons">
        <button
          class="indent-btn"
          [disabled]="!canIndent(field, parentList)"
          (click)="indentField(field, parentList)"
          matTooltip="Move into previous object/array"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
        <button
          class="indent-btn"
          [disabled]="level === 0"
          (click)="outdentField(field, parentList, level)"
          matTooltip="Move out of parent"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>
      </div>

      <!-- Expand/Collapse -->
      @if (field.type === 'object' || field.type === 'array') {
        <button
          class="expand-btn"
          (click)="toggleExpand(field)"
          matTooltip="{{ field.expanded ? 'Collapse' : 'Expand' }}"
        >
          <mat-icon>{{ field.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
        </button>
      } @else {
        <span class="expand-placeholder"></span>
      }

      <!-- Type Icon -->
      <mat-icon class="type-icon" [matTooltip]="field.type">{{ getTypeIcon(field.type) }}</mat-icon>

      <!-- Field Name -->
      @if (field.isEditing) {
        <input
          class="field-name-input"
          [value]="field.name"
          (input)="onFieldNameChange(field, $event)"
          (blur)="stopEdit(field)"
          (keydown)="onFieldNameKeydown($event, field)"
          placeholder="Field name"
          autofocus
        />
      } @else {
        <span class="field-name" (dblclick)="startEdit(field)">
          {{ field.name || 'unnamed' }}
          @if (field.type === 'array') {
            <span class="array-indicator">[]</span>
          }
        </span>
      }

      <!-- Required Toggle -->
      <button
        class="required-btn"
        [class.is-required]="field.required"
        (click)="toggleRequired(field)"
        [matTooltip]="field.required ? 'Required (click to make optional)' : 'Optional (click to make required)'"
      >
        <mat-icon>{{ field.required ? 'star' : 'star_border' }}</mat-icon>
      </button>

      <!-- Description Input -->
      <input
        class="description-input"
        [value]="field.description || ''"
        (input)="onDescriptionChange(field, $any($event.target).value)"
        placeholder="Description..."
      />

      <!-- Type Selector -->
      <mat-form-field appearance="outline" class="type-selector">
        <mat-select [value]="field.type" (selectionChange)="onFieldTypeChange(field, $event.value)">
          @for (type of fieldTypes; track type.value) {
            <mat-option [value]="type.value">
              <mat-icon>{{ type.icon }}</mat-icon>
              {{ type.label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <!-- Actions -->
      <div class="field-actions">
        @if (field.type === 'object' || field.type === 'array') {
          <button
            mat-icon-button
            (click)="addChildField(field)"
            matTooltip="Add child field"
          >
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        }
        @if (field.type === 'string' || field.type === 'number') {
          <button
            mat-icon-button
            (click)="toggleValuesEditor(field)"
            [matTooltip]="field.allowedValues?.length ? 'Edit allowed values (' + field.allowedValues.length + ')' : 'Add allowed values'"
            [class.has-values]="field.allowedValues?.length"
          >
            <mat-icon>{{ field.allowedValues?.length ? 'list' : 'list' }}</mat-icon>
          </button>
        }
        <button mat-icon-button [matMenuTriggerFor]="fieldMenu" matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #fieldMenu="matMenu">
          <button mat-menu-item (click)="startEdit(field)">
            <mat-icon>edit</mat-icon>
            <span>Rename</span>
          </button>
          <button mat-menu-item (click)="duplicateField(field, parentList)">
            <mat-icon>content_copy</mat-icon>
            <span>Duplicate</span>
          </button>
          <button mat-menu-item (click)="deleteField(field, parentList)" class="delete-action">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>
    </div>

    <!-- Allowed Values Editor -->
    @if (field.isEditingValues && (field.type === 'string' || field.type === 'number')) {
      <div class="allowed-values-editor" [style.--level]="level">
        <div class="values-header">
          <span class="values-label">Allowed values:</span>
          <input
            #valueInput
            class="value-input"
            type="text"
            placeholder="Type value and press Enter"
            (keydown)="onAllowedValueKeydown($event, field, valueInput)"
          />
          <button class="add-value-btn" (click)="addAllowedValue(field, valueInput)" matTooltip="Add value">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        @if (field.allowedValues && field.allowedValues.length > 0) {
          <div class="values-list">
            @for (value of field.allowedValues; track value; let vi = $index) {
              <span class="value-chip">
                {{ value }}
                <button class="remove-value-btn" (click)="removeAllowedValue(field, vi)" matTooltip="Remove">
                  <mat-icon>close</mat-icon>
                </button>
              </span>
            }
          </div>
        } @else {
          <div class="no-values">No values defined yet</div>
        }
      </div>
    }

    <!-- Nested Children -->
    @if ((field.type === 'object' || field.type === 'array') && field.expanded) {
      <div class="nested-fields" [style.--level]="level + 1">
        @if (field.children && field.children.length > 0) {
          <ng-container *ngTemplateOutlet="fieldListTemplate; context: { fields: field.children, level: level + 1, parentList: field.children }"></ng-container>
        } @else {
          <div class="empty-nested">
            <span>No child fields</span>
            <button mat-button (click)="addChildField(field)" color="primary">
              <mat-icon>add</mat-icon>
              Add field
            </button>
          </div>
        }
      </div>
    }
  }
</ng-template>
